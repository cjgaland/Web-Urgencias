<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Requerimientos Calóricos (TDEE)</title>
<style>
  :root{--c1:#0a5ea8;--c1-600:#0a4c84;--bd:#e1eefc;--bg:#f7fbff;--bx:#d1d9e6;--tx:#0a4c84;--mut:#667085}
  *{box-sizing:border-box}
  body{font-family:Roboto,Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#fff;color:#222}
  h1{font-size:1.25rem;margin:.25rem 0 1rem;color:var(--tx)}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px 16px 18px;max-width:720px;margin:0 auto;box-shadow:0 4px 16px rgba(0,0,0,.05)}
  .sub{color:#475569;margin:-.4rem 0 .8rem;font-size:.95rem}
  .grid{display:grid;gap:.9rem}
  .row{display:grid;gap:.5rem;grid-template-columns:1fr 1fr;align-items:center}
  .ig{display:grid;grid-template-columns:1fr 180px;gap:.5rem}
  label{font-weight:600;color:#334155}
  input[type=number],select{border:1px solid var(--bx);border-radius:10px;padding:.6rem .65rem;font-size:1rem;width:100%}
  select{max-width:100%}
  .actions{display:flex;gap:.6rem;margin-top:.4rem;flex-wrap:wrap;align-items:center}
  .actions .spacer{flex:1 1 auto}
  .btn{padding:.6rem .9rem;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:500}
  .btn.primary{background:var(--c1);color:#fff}.btn.primary:hover{background:var(--c1-600)}
  .btn.secondary{background:#eef2f7;color:var(--tx);border-color:#d9e2ec}.btn.secondary:hover{background:#e6ebf2}
  .btn.close{margin-left:auto;background:var(--c1-600);color:#fff;border-color:#083554}
  .btn.close:hover{filter:brightness(1.05)}
  .result{margin-top:.9rem;padding:.9rem;border:1px solid var(--bd);background:var(--bg);border-radius:10px;color:var(--tx);white-space:pre-wrap}
  .muted{color:var(--mut);font-size:.9rem}
  @media (max-width:560px){.row{grid-template-columns:1fr}.ig{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="card">
  <h1 style="margin-bottom:.4rem">Requerimientos Calóricos (TDEE)</h1>
  <p class="sub" style="margin-top:0">Calcula el gasto energético total aplicando factores de actividad y estrés a partir del BMR.</p>

  <form id="formTDEE" class="grid">
    <div class="row">
      <label for="sexo">Sexo</label>
      <select id="sexo" required>
        <option value="M">Varón</option>
        <option value="F">Mujer</option>
      </select>
    </div>

    <div class="row">
      <label for="edad">Edad</label>
      <div class="ig">
        <input id="edad" type="number" step="1" min="0" placeholder="Ej. 45" required />
        <span></span>
      </div>
    </div>

    <div class="row">
      <label for="peso">Peso</label>
      <div class="ig">
        <input id="peso" type="number" step="0.1" min="0" placeholder="Ej. 70" required />
        <select id="pesoUnit"><option value="kg">kg</option><option value="lb">lb</option></select>
      </div>
    </div>

    <div class="row">
      <label for="talla">Talla</label>
      <div class="ig">
        <input id="talla" type="number" step="0.1" min="0" placeholder="Ej. 175" required />
        <select id="tallaUnit"><option value="cm">cm</option><option value="m">m</option><option value="in">in</option></select>
      </div>
    </div>

    <div class="row" style="grid-template-columns:1fr;">
      <label for="formula">BMR - Fórmula</label>
      <select id="formula">
        <option value="mifflin">Mifflin–St Jeor</option>
        <option value="hb">Harris–Benedict (revisado)</option>
      </select>
    </div>

    <div class="row" style="grid-template-columns:1fr;">
      <label for="actividad">Actividad física</label>
      <select id="actividad">
        <option value="1.2">Sedentario (×1.2)</option>
        <option value="1.375">Ligero 1–3 d/sem (×1.375)</option>
        <option value="1.55">Moderado 3–5 d/sem (×1.55)</option>
        <option value="1.725">Alto 6–7 d/sem (×1.725)</option>
        <option value="1.9">Muy alto (×1.9)</option>
      </select>
    </div>

    <div class="row" style="grid-template-columns:1fr;">
      <label for="estres">Factor enfermedad/estrés (opcional)</label>
      <select id="estres">
        <option value="1">Sin estrés (×1.0)</option>
        <option value="1.1">Leve (×1.1)</option>
        <option value="1.2">Moderado (×1.2)</option>
        <option value="1.3">Severo (×1.3)</option>
        <option value="1.5">Crítico (×1.5)</option>
      </select>
      <p class="muted">Ajusta según contexto clínico (ej. infección, trauma, postoperatorio).</p>
    </div>

    <div class="actions">
      <button type="submit" class="btn primary">Calcular</button>
      <button type="button" id="copyBtn" class="btn secondary">Copiar resultado</button>
      <button type="reset" class="btn secondary">Limpiar</button>
          <span class="spacer"></span>
      <button type="button" id="closeBtn" class="btn close" title="Cerrar esta ventana">Cerrar ventana</button>
    </div>

    <div id="result" class="result" aria-live="polite">Introduce datos y pulsa “Calcular”.</div>
    <p class="muted">Resultados en kcal/día. Úsalo como orientación y ajusta clínicamente.</p>
  </form>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id), r=(v,d=0)=>Math.round((v+Number.EPSILON)*(10**d))/(10**d);
  const toKg=(v,u)=>u==='lb'?v*0.45359237:v;
  const toCm=(v,u)=>u==='m'?v*100:(u==='in'?v*2.54:v);

  function bmrCalc(sex,age,kg,cm,formula){
    if(formula==='mifflin'){
      const s = (sex==='M') ? 5 : -161;
      return 10*kg + 6.25*cm - 5*age + s;
    }else{
      return (sex==='M')
        ? 88.362 + 13.397*kg + 4.799*cm - 5.677*age
        : 447.593 +  9.247*kg + 3.098*cm - 4.330*age;
    }
  }

  $('formTDEE').addEventListener('submit',e=>{
    e.preventDefault();
    const sex=$('sexo').value;
    const age=parseFloat($('edad').value);
    const kg=toKg(parseFloat($('peso').value),$('pesoUnit').value);
    const cm=toCm(parseFloat($('talla').value),$('tallaUnit').value);
    const f=$('formula').value;
    const act=parseFloat($('actividad').value);
    const str=parseFloat($('estres').value);
    if(!(age>=0)||!(kg>0)||!(cm>0)) return $('result').textContent='Revisa valores.';

    const bmr = bmrCalc(sex,age,kg,cm,f);
    const tdee = bmr * act * str;

    $('result').textContent = `BMR (${f==='mifflin'?'Mifflin–St Jeor':'Harris–Benedict (rev.)'}): ${r(bmr)} kcal/día\n` +
                              `Actividad ×${act} y estrés ×${str}\n` +
                              `Requerimiento calórico estimado (TDEE): ${r(tdee)} kcal/día`;
  });

  $('copyBtn').addEventListener('click',()=>{
    const t=$('result').textContent||''; if(!t.trim()) return alert('No hay resultado.');
    navigator.clipboard.writeText(t).then(()=>{ $('copyBtn').textContent='¡Copiado!'; setTimeout(()=>$('copyBtn').textContent='Copiar resultado',900); });
  });

  // Cierre inteligente
  function smartClose(){
    try{
      if(window.opener && !window.opener.closed){
        window.close();
        return;
      }
    }catch(e){}
    if(history.length > 1){
      history.back();
    }else{
      location.href = '../index.html'; // Ajusta si tu índice está en otra ruta
    }
  }
  var _closeBtn = document.getElementById('closeBtn');
  if(_closeBtn){ _closeBtn.addEventListener('click', smartClose); }
})();
</script>
</body>
</html>
