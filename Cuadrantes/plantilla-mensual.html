<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuadrante ‚Äì Urgencias ¬∑ AGS Sur de C√≥rdoba</title>
  <link rel="stylesheet" href="../css/style.css?v=20250824" />
  <style>
    :root { --gap:.5rem; --radius:12px; --shadow:0 2px 12px rgba(0,0,0,.08); }
    body { background:#f4f7fb; }
    .wrap { max-width:1200px; margin:2rem auto; padding:0 1rem; }
    .toolbar { display:flex; gap:var(--gap); align-items:center; justify-content:space-between; margin-bottom:1rem; flex-wrap:wrap; }
    .toolbar .left, .toolbar .right { display:flex; gap:var(--gap); align-items:center; }
    .toolbar h1 { font-size:clamp(1.2rem,2vw,1.6rem); font-weight:600; }
    .toolbar .badge { background:#00457c; color:#fff; padding:.35rem .6rem; border-radius:999px; font-size:.85rem; }
    .toolbar button { border:none; border-radius:999px; padding:.55rem .9rem; cursor:pointer; box-shadow:var(--shadow); background:#fff; font-weight:600; }
    .panel { background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); padding:1rem; }

    table.cuadrante { width:100%; border-collapse:separate; border-spacing:0; font-size:.92rem; }
    table.cuadrante thead th { position:sticky; top:0; background:#f7fafc; z-index:1; }
    table.cuadrante th, table.cuadrante td { padding:.45rem .5rem; text-align:center; border-bottom:1px solid #eef2f7; }
    table.cuadrante th:first-child, table.cuadrante td:first-child { text-align:left; position:sticky; left:0; background:#fff; }

    /* Colores de turnos */
    .shift-M{background:#E6F4EA}
    .shift-T{background:#E6ECFF}
    .shift-G{background:#EAF7FF}
    .shift-O{background:#FFF0F5}
    .shift-F{background:#FFF5E6}
    .shift-FO{background:#FFECEC}
    .shift-R{background:#E0F7FA}
    .shift-V{background:#FDF4FF}
    .shift-S{background:#F5F7FA;color:#99A3AD}
    .shift-LD{background:#F0FDF4}
    .shift-FR{background:#F3E8FF}
    .shift-OT{background:#F2F2F2}

    .legend { display:flex; flex-wrap:wrap; gap:.5rem .75rem; margin-top:.75rem; }
    .legend .item { display:flex; align-items:center; gap:.35rem; font-size:.9rem; }
    .legend .swatch { width:18px; height:14px; border-radius:4px; box-shadow: inset 0 0 0 1px rgba(0,0,0,.06); }

    .totales { margin-top:1rem; display:grid; gap:.5rem; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); }
    .totales .card { background:#fff; border-radius:var(--radius); box-shadow:var(--shadow); padding:.75rem .9rem; }
    .totales .card h3 { font-size:.9rem; font-weight:600; color:#00457c; }
    .totales .card p { margin:.25rem 0 0; font-weight:700; font-size:1.1rem; }

    @media print {
      body { background:#fff; }
      .toolbar, .legend { display:none; }
      .panel { box-shadow:none; border:none; }
      table.cuadrante th, table.cuadrante td { padding:.28rem .3rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="left">
        <h1 id="titulo"></h1>
        <span class="badge" id="badge-equipo" title="√Årea de Urgencias y Observaci√≥n">Urgencias</span>
      </div>
      <div class="right">
        <button id="btn-print">üñ®Ô∏è Imprimir</button>
        <button id="btn-export">‚¨áÔ∏è Exportar CSV</button>
      </div>
    </div>

    <div class="panel">
      <div style="overflow:auto;">
        <table class="cuadrante" id="tabla">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="legend" id="leyenda"></div>
      <div class="totales" id="totales"></div>
    </div>
  </div>

  <script>
    // Par√°metros (?csv=AAAA-MM&mes=M&anno=AAAA). Si faltan, usa mes/a√±o actuales.
    const params = new URLSearchParams(window.location.search);
    const mesParam  = parseInt(params.get('mes')  || '') || (new Date().getMonth() + 1); // 1..12
    const annoParam = parseInt(params.get('anno') || '') || (new Date().getFullYear());
    const csvId     = params.get('csv') || `${annoParam}-${String(mesParam).padStart(2,'0')}`;

    const MESES = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    const DOW   = ['D','L','M','X','J','V','S']; // 0=Dom
    const CODIGOS = {
      M:{nombre:'Ma√±ana 08‚Äì15', clase:'shift-M'},
      T:{nombre:'Tarde 15‚Äì22', clase:'shift-T'},
      G:{nombre:'Guardia laborable 15‚Äì08', clase:'shift-G'},
      O:{nombre:'Guardia Observaci√≥n 08‚Äì15 (d√≠a sig.)', clase:'shift-O'},
      F:{nombre:'Guardia Festivo 09‚Äì09', clase:'shift-F'},
      FO:{nombre:'Obs. Festivo 10‚Äì10', clase:'shift-FO'},
      R:{nombre:'Refuerzo 10‚Äì22 (s√≥lo findes/festivos)', clase:'shift-R'},
      V:{nombre:'Vacaciones', clase:'shift-V'},
      S:{nombre:'Saliente', clase:'shift-S'},
      LD:{nombre:'Libre disposici√≥n', clase:'shift-LD'},
      FR:{nombre:'Formaci√≥n', clase:'shift-FR'},
      OT:{nombre:'Otros', clase:'shift-OT'}
    };

    const tituloMes = `Cuadrante ¬∑ ${MESES[mesParam-1]} ${annoParam}`;
    document.getElementById('titulo').textContent = tituloMes;
    document.title = `${tituloMes} ‚Äì Urgencias ¬∑ AGS Sur de C√≥rdoba`;

    function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); } // m=1..12
    function labelDia(y,m,d){ const dow=new Date(y, m-1, d).getDay(); return `${DOW[dow]} ${d}`; }
    const numDias = daysInMonth(annoParam, mesParam);

    // Encabezado
    const thead = document.getElementById('thead');
    const trHead = document.createElement('tr');
    const thNombre = document.createElement('th'); thNombre.textContent = 'Profesional'; trHead.appendChild(thNombre);
    for (let d=1; d<=numDias; d++){ const th=document.createElement('th'); th.textContent=labelDia(annoParam, mesParam, d); trHead.appendChild(th); }
    const thObs = document.createElement('th'); thObs.textContent = 'Obs.'; trHead.appendChild(thObs);
    thead.appendChild(trHead);

    // Leyenda
    const leyenda = document.getElementById('leyenda');
    Object.entries(CODIGOS).forEach(([k,v])=>{
      const item = document.createElement('div'); item.className='item'; item.title=v.nombre;
      const sw = document.createElement('span'); sw.className='swatch '+v.clase; item.appendChild(sw);
      const txt = document.createElement('span'); txt.textContent = `${k} = ${v.nombre}`; item.appendChild(txt);
      leyenda.appendChild(item);
    });

    // Cargar CSV (data cuelga de Cuadrantes/)
    const csvPath = `data/cuadrantes/${csvId}.csv?v=${Date.now()}`;
    fetch(csvPath).then(r => { if(!r.ok) throw new Error('No se encontr√≥ el CSV: '+csvPath); return r.text(); })
      .then(txt => { const rows = parseCSV(txt); renderTabla(rows); renderTotales(rows); })
      .catch(err => {
        console.error(err);
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan = numDias + 2; td.style.textAlign='left';
        td.innerHTML = `‚ö†Ô∏è ${err.message}.<br>Comprueba la ruta y que el archivo exista.`;
        tr.appendChild(td); document.getElementById('tbody').appendChild(tr);
      });

    function parseCSV(input){
      const lines = input.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
      return lines.map(line=>{
        const row=[]; let cur=''; let inQ=false;
        for (let i=0;i<line.length;i++){
          const ch=line[i], next=line[i+1];
          if (ch=='"'){ if(inQ && next=='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
          else if (ch==',' && !inQ){ row.push(cur); cur=''; }
          else { cur+=ch; }
        } row.push(cur); return row;
      });
    }

    function tokenizar(val){
      const raw = val.toUpperCase().trim();
      if (!raw) return [];
      return raw.split(/[ \\/+\-]+/).filter(Boolean);
    }

    function renderTabla(rows){
      const tbody = document.getElementById('tbody');
      for (let i=1; i<rows.length; i++){
        const r = rows[i]; if (!r || !r.length) continue;
        const tr = document.createElement('tr');
        const tdNombre = document.createElement('td'); tdNombre.textContent = (r[0]||'').trim(); tr.appendChild(tdNombre);
        for (let d=1; d<=numDias; d++){
          const td = document.createElement('td');
          const val = (r[d]||'').toString().trim();
          if (val){
            const tokens = tokenizar(val);
            const firstKnown = tokens.find(t => CODIGOS[t]);
            if (firstKnown) td.classList.add(CODIGOS[firstKnown].clase);
            td.textContent = tokens.join('+');
          }
          tr.appendChild(td);
        }
        const tdObs = document.createElement('td'); tdObs.textContent = (r[numDias+1]||'').trim(); tr.appendChild(tdObs);
        tbody.appendChild(tr);
      }
    }

    function renderTotales(rows){
      const tot = {}; // { nombre: {M:0,T:0,...} }
      for (let i=1; i<rows.length; i++){
        const r = rows[i]; const nombre = (r[0]||'').trim(); if (!nombre) continue;
        if (!tot[nombre]) tot[nombre] = {M:0,T:0,G:0,O:0,F:0,FO:0,R:0,V:0,S:0,LD:0,FR:0,OT:0};
        for (let d=1; d<=numDias; d++){
          const val = (r[d]||'').toString().trim(); if (!val) continue;
          const tokens = tokenizar(val);
          for (const t of tokens){ if (tot[nombre][t] !== undefined) tot[nombre][t]++; }
        }
      }
      const box = document.getElementById('totales'); box.innerHTML = '';
      Object.entries(tot).forEach(([nombre,counts])=>{
        const c = document.createElement('div'); c.className='card';
        const totalJornadas = Object.values(counts).reduce((a,b)=>a+b,0);
        c.innerHTML = `<h3>${nombre}</h3><p>${totalJornadas} turnos</p>` +
          `<div style="margin-top:.35rem; display:flex; flex-wrap:wrap; gap:.35rem .6rem; font-size:.85rem;">`+
          Object.entries(counts).filter(([k,v])=>v>0).map(([k,v])=>`<span class="badge ${CODIGOS[k]?.clase||''}" style="display:inline-block; padding:.18rem .45rem; border-radius:999px;">${k}: ${v}</span>`).join(' ')
          + `</div>`;
        box.appendChild(c);
      });
    }

    // Botones
    document.getElementById('btn-print').addEventListener('click',()=>window.print());
    document.getElementById('btn-export').addEventListener('click',()=>exportTableToCSV());

    function exportTableToCSV(filename = `cuadrante-${annoParam}-${String(mesParam).padStart(2,'0')}.csv`){
      const table = document.getElementById('tabla');
      const rows = Array.from(table.querySelectorAll('tr'));
      const csv = rows.map(tr => Array.from(tr.children).map(td => {
        const raw = td.textContent.replace(/^([DLXJVS])\s+/,'').replaceAll('"','""'); // limpia prefijo d√≠a-semana
        return /[",\n]/.test(raw) ? `"${raw}"` : raw;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click();
      URL.revokeObjectURL(link.href);
    }
  </script>
</body>
</html>
